<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catégorie - StreamYourDay</title>
    <link rel="stylesheet" href="css/category.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body class="dark-mode">
    <div class="background"></div>
    <div class="sidebar">
        <div class="hamburger"><i class="fas fa-bars"></i></div>
        <div class="logo">
            <img src="src/logo.png" alt="Logo StreamYourDay">
        </div>
        <h2>Genres</h2>
        <ul>
            <li><a href="category.html?category=tous"><i class="fas fa-globe"></i> Tous</a></li>
            <li><a href="category.html?category=jeux-video"><i class="fas fa-gamepad"></i> Jeux Vidéo</a></li>
            <li><a href="category.html?category=sport"><i class="fas fa-futbol"></i> Sport</a></li>
            <li><a href="category.html?category=chatting"><i class="fas fa-comment"></i> Chatting</a></li>
            <li><a href="category.html?category=musique"><i class="fas fa-music"></i> Musique</a></li>
            <li><a href="category.html?category=cuisine"><i class="fas fa-utensils"></i> Cuisine</a></li>
            <li><a href="category.html?category=art"><i class="fas fa-paint-brush"></i> Art</a></li>
        </ul>
        <h2>Navigation</h2>
        <ul id="nav-links">
            <li><a href="profile.html"><i class="fas fa-user"></i> Profil</a></li>
            <li><a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
        </ul>
    </div>
    <div class="main-content">
        <header>
            <h1 id="categoryTitle">Streams</h1>
            <button class="theme-toggle"><i class="fas fa-sun"></i></button>
        </header>
        <section class="stream-grid" id="categoryStreams">
            <!-- Les streams seront insérés ici -->
        </section>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.querySelector('.hamburger').addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('collapsed');
        });

        document.querySelector('.theme-toggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            document.body.classList.toggle('light-mode');
            const btn = document.querySelector('.theme-toggle');
            btn.innerHTML = document.body.classList.contains('dark-mode')
                ? '<i class="fas fa-sun"></i>'
                : '<i class="fas fa-moon"></i>';
        });

        // Vérifier l'état de connexion
        async function checkLoginStatus() {
            const response = await fetch('/api/profile', { credentials: 'include' });
            const navLinks = document.getElementById('nav-links');
            if (response.ok) {
                navLinks.style.display = 'block';
            } else {
                navLinks.innerHTML = '<li><a href="auth.html"><i class="fas fa-sign-in-alt"></i> Connexion</a></li>';
            }
        }
        checkLoginStatus();

        // Déconnexion
        document.getElementById('logout').addEventListener('click', async (e) => {
            e.preventDefault();
            await fetch('/api/logout', { credentials: 'include' });
            window.location.href = '/index.html';
        });

        // Récupérer la catégorie depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get('category') || 'tous';
        document.getElementById('categoryTitle').textContent = category === 'tous' ? 'Tous les Streams' : `Streams - ${category.replace('-', ' ').toUpperCase()}`;

        // Charger les streams
        async function loadCategoryStreams() {
            const response = await fetch('/api/active-streams', { credentials: 'include' });
            const streams = await response.json();
            const streamGrid = document.getElementById('categoryStreams');

            // Filtrer les streams par catégorie
            const filteredStreams = category === 'tous' ? streams : streams.filter(stream => stream.category === category);

            streamGrid.innerHTML = '';
            if (filteredStreams.length === 0) {
                streamGrid.innerHTML = '<p>Aucun stream actif dans cette catégorie pour le moment.</p>';
                return;
            }

            filteredStreams.forEach(stream => {
                const card = document.createElement('div');
                card.className = 'stream-card';
                card.innerHTML = `
                    <div class="thumbnail"><span class="live-badge">LIVE</span></div>
                    <h3>${stream.title}</h3>
                    <p>Streamer: <a href="profile.html">${stream.username}</a> | <span class="viewer-count">${stream.viewers}</span> spectateurs</p>
                    <button onclick="watchStream('${stream.streamId}')">Regarder</button>
                    <button onclick="subscribeTo('${stream.username}')"><i class="fas fa-user-plus"></i> S'abonner</button>
                    <button onclick="likeStream('${stream.streamId}')"><i class="fas fa-heart"></i> Aimer</button>
                `;
                streamGrid.appendChild(card);
            });
        }

        // Fonctions pour les actions
        function watchStream(streamId) {
            window.location.href = `/stream.html?streamId=${streamId}`;
        }

        async function subscribeTo(streamer) {
            const response = await fetch('/api/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ streamer }),
                credentials: 'include',
            });
            const data = await response.json();
            alert(data.message);
        }

        async function likeStream(streamId) {
            const response = await fetch('/api/like-stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ streamId }),
                credentials: 'include',
            });
            const data = await response.json();
            alert(data.message);
        }

        // Charger les streams au démarrage
        loadCategoryStreams();

        // Écouter les nouveaux streams via Socket.IO
        const socket = io();
        socket.on('new-stream', loadCategoryStreams);
    </script>
</body>

</html>